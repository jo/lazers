<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>yakshav.es</title>
    <link rel="stylesheet" href="/css/site.css">
    <link rel="stylesheet" href="/css/hack.css">
    <link rel="stylesheet" href="/css/highlight.css">
  </head>
  <body class="hack">
    <div class="container">

<h1 id="liblazers">liblazers</h1>
<p>The C interface to laze.rs.</p>
<div class="sourceCode"><pre class="sourceCode rust"><code class="sourceCode rust"><span class="kw">extern</span> <span class="kw">crate</span> lazers_hyper_client;
<span class="kw">extern</span> <span class="kw">crate</span> lazers_traits;
<span class="kw">extern</span> <span class="kw">crate</span> libc;

<span class="kw">use</span> std::any::Any;
<span class="kw">use</span> std::ffi::CStr;
<span class="kw">use</span> lazers_traits::Client;
<span class="kw">use</span> lazers_hyper_client::HyperClient;

<span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span>
<span class="kw">pub</span> <span class="kw">struct</span> CClient {
    inspect: <span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span>(*<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>) -&gt; (),
    close: <span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span>(*<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>) -&gt; (),
    get: <span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span>(*<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>, *<span class="kw">mut</span> std::os::raw::<span class="dt">c_char</span>) -&gt; (),
    client: *<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>,
}

<span class="kw">pub</span> <span class="kw">trait</span> CClientInterface {
    <span class="kw">fn</span> inspect(&amp;<span class="kw">self</span>);
    <span class="kw">fn</span> get(&amp;<span class="kw">self</span>, key: &amp;<span class="dt">str</span>);
}

<span class="kw">impl</span>&lt;C: CClientInterface&gt; From&lt;<span class="dt">Box</span>&lt;C&gt;&gt; <span class="kw">for</span> CClient {
    <span class="kw">fn</span> from(i: <span class="dt">Box</span>&lt;C&gt;) -&gt; CClient {
        CClient {
            inspect: inspect::&lt;C&gt;,
            close: close::&lt;C&gt;,
            get: get::&lt;C&gt;,
            client: <span class="dt">Box</span>::into_raw(i) <span class="kw">as</span> *<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>,
        }
    }
}

<span class="kw">impl</span> CClientInterface <span class="kw">for</span> HyperClient {
    <span class="kw">fn</span> inspect(&amp;<span class="kw">self</span>) {
        <span class="pp">println!</span>(<span class="st">&quot;hey from hyperclient&quot;</span>);
    }
    <span class="kw">fn</span> get(&amp;<span class="kw">self</span>, key: &amp;<span class="dt">str</span>) {
        <span class="pp">println!</span>(<span class="st">&quot;hey from get: {}&quot;</span>, key);
    }
}

<span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> inspect&lt;C: CClientInterface&gt;(client: *<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>) {
    <span class="kw">let</span> client: <span class="dt">Box</span>&lt;C&gt; = <span class="dt">Box</span>::from_raw(client <span class="kw">as</span> *<span class="kw">mut</span> C);
    client.inspect();
    std::mem::forget(client);
}

<span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> get&lt;C: CClientInterface&gt;(client: *<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>,
                                              raw_key: *<span class="kw">mut</span> std::os::raw::<span class="dt">c_char</span>) {
    <span class="kw">let</span> client: <span class="dt">Box</span>&lt;C&gt; = <span class="dt">Box</span>::from_raw(client <span class="kw">as</span> *<span class="kw">mut</span> C);
    <span class="kw">let</span> key = CStr::from_ptr(raw_key).to_str().unwrap();
    client.get(key);
    std::mem::forget(client);
}

<span class="kw">unsafe</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> close&lt;C: CClientInterface&gt;(client: *<span class="kw">mut</span> std::os::raw::<span class="dt">c_void</span>) {
    <span class="kw">let</span> client = client <span class="kw">as</span> *<span class="kw">mut</span> CClient;
    <span class="dt">Box</span>::from_raw((*client).client <span class="kw">as</span> *<span class="kw">mut</span> C);
}

<span class="at">#[</span>no_mangle<span class="at">]</span>
<span class="kw">pub</span> <span class="kw">extern</span> <span class="st">&quot;C&quot;</span> <span class="kw">fn</span> lzrs_new_hyper_client() -&gt; *<span class="kw">mut</span> CClient {
    <span class="kw">let</span> client = <span class="dt">Box</span>::new(HyperClient::default());
    <span class="kw">let</span> client_structure = <span class="dt">Box</span>::new(client.into());
    <span class="dt">Box</span>::into_raw(client_structure)
}


<span class="at">#[</span>test<span class="at">]</span>
<span class="kw">fn</span> sizes() {
    <span class="kw">use</span> std::mem::size_of;
    <span class="pp">assert_eq!</span>(size_of::&lt;<span class="dt">Box</span>&lt;HyperClient&gt;&gt;(), <span class="dv">8</span>);
    <span class="pp">assert_eq!</span>(size_of::&lt;<span class="dt">Box</span>&lt;Any&gt;&gt;(), <span class="dv">16</span>);
}</code></pre></div>

      <a href="/">top<a/>
    </div>
  </body>
  <script src="./prism.js"></script>
</html>
